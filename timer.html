<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notion Timer Widget</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel1: #121a2b;
      --panel2: #0e1626;
      --text: #d9e2ef;
      --muted: #8aa1b4;
      --accent: #1fb6ff;
      --accent2: #34d399;
      --danger: #ef4444;
      --shadow: rgba(0,0,0,.35);
      --radius: 18px;
      --font-ui: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    body {
      margin: 0; height: 100%;
      background: var(--bg); color: var(--text);
      font-family: var(--font-ui);
      display: grid; place-items: center;
    }
    .wrap {
      display: grid;
      gap: 12px;
      padding: 20px;
      border-radius: var(--radius);
      background: var(--panel1);
      box-shadow: 0 4px 12px var(--shadow);
      text-align: center;
    }
    .labelbar {
      font-weight: 600; font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .timer {
      font-size: 3rem;
      font-weight: bold;
      margin: 10px 0;
    }
    svg {
      width: 160px; height: 160px;
      transform: rotate(-90deg);
    }
    .ring-bg { stroke: var(--panel2); stroke-width: var(--ring-width, 12); }
    .ring-progress { stroke: var(--accent); stroke-linecap: round; stroke-width: var(--ring-width, 12); }
    .controls button {
      margin: 4px; padding: 8px 16px;
      border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer;
    }
    .start { background: var(--accent); color: white; }
    .stop { background: var(--danger); color: white; }
    .msg { margin-top: 6px; font-size: .9rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="labelbar" id="label">Session</div>
    <svg>
      <circle class="ring-bg" r="70" cx="80" cy="80" fill="none"/>
      <circle class="ring-progress" r="70" cx="80" cy="80" fill="none" stroke-dasharray="440" stroke-dashoffset="0"/>
    </svg>
    <div class="timer" id="timer">00:00</div>
    <div class="controls">
      <button class="start" id="startBtn">Start</button>
      <button class="stop" id="stopBtn">Stop</button>
      <button id="resetBtn">Reset</button>
    </div>
    <div class="msg" id="status">Idle</div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);

    // Params
    const label = qs.get("label") || "Session";
    const mins = Number(qs.get("mins")) || 25;
    const brk = Number(qs.get("break")) || 5;
    const accent = qs.get("accent");
    const accent2 = qs.get("accent2");
    const ring = qs.get("ring") || "normal"; // thin, normal, thick
    const glow = qs.get("glow") === "1";
    const radius = qs.get("radius");
    const autoswitch = qs.get("autoswitch") === "1";
    const autowork = qs.get("autowork") === "1";
    const sound = qs.get("sound") || "ding";
    const labelbar = qs.get("labelbar") !== "0";
    const next = qs.get("next");
    const toast = qs.get("toast");

    document.getElementById("label").textContent = label;
    if (!labelbar) document.getElementById("label").style.display = "none";
    if (accent) document.documentElement.style.setProperty("--accent", accent);
    if (accent2) document.documentElement.style.setProperty("--accent2", accent2);
    if (radius) document.documentElement.style.setProperty("--radius", radius+"px");
    if (ring==="thin") document.documentElement.style.setProperty("--ring-width","6");
    if (ring==="thick") document.documentElement.style.setProperty("--ring-width","16");

    const ringEl = document.querySelector(".ring-progress");
    const dash = 440;
    ringEl.setAttribute("stroke-dasharray", dash);

    let total = mins*60, time = total, interval, isRunning=false;

    function updateRing() {
      const offset = dash - (time/total)*dash;
      ringEl.setAttribute("stroke-dashoffset", offset);
      const m = Math.floor(time/60).toString().padStart(2,"0");
      const s = (time%60).toString().padStart(2,"0");
      document.getElementById("timer").textContent = `${m}:${s}`;
    }
    function tick() {
      if (time>0) { time--; updateRing(); }
      else { stop(); finished(); }
    }
    function start() {
      if (isRunning) return;
      isRunning=true;
      interval=setInterval(tick,1000);
      document.getElementById("status").textContent="Running";
    }
    function stop() {
      isRunning=false;
      clearInterval(interval);
      document.getElementById("status").textContent="Stopped";
    }
    function reset() {
      stop();
      time=total;
      updateRing();
      document.getElementById("status").textContent="Reset";
    }
    function finished() {
      document.getElementById("status").textContent="Done!";
      if (toast) alert(toast);
      if (sound!=="none") new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
      if (next) window.open(next,"_blank");
      if (autoswitch) {
        total = (total==mins*60 ? brk*60 : mins*60);
        time=total; updateRing();
        if (autowork) start();
      }
    }

    document.getElementById("startBtn").onclick=start;
    document.getElementById("stopBtn").onclick=stop;
    document.getElementById("resetBtn").onclick=reset;
    document.addEventListener("keydown",e=>{
      if(e.code==="Space"){ e.preventDefault(); isRunning?stop():start(); }
      if(e.key.toLowerCase()==="r") reset();
    });

    // Init
    updateRing();
    if(qs.get("autostart")==="1") start();
  </script>
</body>
</html>
